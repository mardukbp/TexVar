% LaTeX Package for TexVar - LaTeX math calculations
% Version 0.1.0
%
% This work may be distributed and/or modified under the
% terms of the MIT license.
% 
\ProvidesPackage{texvar}[2015/10/24 TexVar]
%
% Load luacode
\RequirePackage{luacode}
%
% Load TexVar Library
\directlua{require("tVar/init.lua")}
%
% Additions to luacode
% New Definition for luacode enviroment to run \end{tVar} code at encounter
\newcommand*\tVar@begin [1] {%
	\begingroup
	\escapechar92
	\luatexcatcodetable#1\relax
	\edef\luacode@endmark{\string\end{tVar}}%
\expandafter\def \expandafter\luacode@endmark \expandafter{%
	\luatexscantextokens \expandafter{\luacode@endmark}}%
\tVar@grab@body ~}
%
\newcommand\tVar@end{%
	\edef\luacode@next{%
		\noexpand\luacode@execute{\the\luacode@lines}%
		\noexpand\end{tVar}}%
\expandafter\endgroup
\luacode@next}
%
% Needed for calling the customized tVar@grab@lines
\newcommand\tVar@grab@body [1] {%
	\luacode@lines{}%
	\endlinechar10
	\tVar@grab@lines}
%
% Changed one line of original function
\long\def\tVar@grab@lines#1^^J{%
	\def\luacode@curr{#1}%
	\luacode@strip@spaces
	\ifx\luacode@curr\luacode@endmark
	% New line add ]] at end of lines
	\expandafter\luacode@addline\expandafter{]]}%
	\expandafter\tVar@end
	\else
	\expandafter\luacode@addline\expandafter{\luacode@curr}%
	\expandafter\tVar@grab@lines
	\fi}
%
% Declare Enviroment
\newenvironment {tVar} {\tVar@begin\CatcodeTableOther tVar[[}  {}